<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Speech component</title>
  </head>
  <body>
    <div style="font-family: sans-serif;">
      <button id="startBtn">Iniciar reconocimiento (habla ahora)</button>
      <button id="stopBtn" style="margin-left:10px;">Detener</button>
      <p id="status" style="color: #333;"></p>
      <p id="result" style="font-weight:bold;"></p>
    </div>

    <script>
      // Este componente usa la Web Speech API del navegador.
      // Al obtener un resultado, envía el texto a Streamlit mediante postMessage.
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const status = document.getElementById("status");
      const result = document.getElementById("result");

      // compatibility
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        status.innerText = "Web Speech API no está disponible en este navegador. Usa Chrome/Edge en escritorio.";
        startBtn.disabled = true;
        stopBtn.disabled = true;
      } else {
        const recognition = new SpeechRecognition();
        recognition.lang = "es-ES";
        recognition.interimResults = false;
        recognition.continuous = false;

        recognition.onstart = () => {
          status.innerText = "Escuchando...";
        };
        recognition.onend = () => {
          status.innerText = "Detenido.";
        };
        recognition.onerror = (ev) => {
          status.innerText = "Error: " + ev.error;
        };
        recognition.onresult = (ev) => {
          const text = Array.from(ev.results).map(r => r[0].transcript).join('');
          result.innerText = text;
          // Enviamos el resultado a Streamlit. Streamlit captura postMessage y lo devuelve.
          const payload = { isStreamlitMessage: true, text: text };
          window.parent.postMessage(payload, "*");
        };

        startBtn.addEventListener("click", () => {
          try {
            recognition.start();
          } catch (e) {
            // Ignore if start called multiple times
            console.warn(e);
          }
        });
        stopBtn.addEventListener("click", () => {
          try { recognition.stop(); } catch (e) {}
        });
      }
    </script>
  </body>
</html>
